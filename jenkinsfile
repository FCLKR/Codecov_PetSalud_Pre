pipeline {
  agent any

  stages {

    stage('Checkout') {
      steps {
        echo "ðŸ“¦ Clonando el repositorio..."
        checkout scm
      }
    }

    stage('Deploy') {
      steps {
        echo "ðŸš€ Iniciando despliegue con Docker Compose..."

        // Copiamos el proyecto fuera del workspace de Jenkins
        sh '''
          set -e

          echo "Copiando proyecto a /tmp/petsalud..."
          rm -rf /tmp/petsalud
          mkdir -p /tmp/petsalud
          cp -r . /tmp/petsalud

          cd /tmp/petsalud

          echo "Construccion del proyecto..."
          docker compose build --no-cache

          
        '''
        /*echo "Levantando servicios con Docker Compose..."
          docker compose up -d

          echo "Contenedores en ejecuciÃ³n:"
          docker compose ps*/
      }
    }
    stage('Test Mysql') {
      steps {
        echo "ðŸš€ Iniciando despliegue con Docker Compose..."

        // Copiamos el proyecto fuera del workspace de Jenkins
        sh '''
          set -e

          echo "UP Mysql"
          sleep 10
          
        '''
      }
    }
    stage('Run Tests in Backend Container') {
            steps {
                sh '''
                docker-compose run --rm backend bash -c "
                    pip install coverage pytest &&
                    coverage run -m pytest &&
                    coverage xml
                "
                '''
            }
        }
    stage('Copy Coverage Report to Host') {
            steps {
                sh '''
                docker cp $(docker ps -aqf "name=backend"):/app/coverage.xml .
                '''
            }
        }

    stage('Upload to Codecov') {
            steps {
                sh '''
                bash <(curl -s https://codecov.io/bash) -f coverage.xml -R .
                '''
            }
        }
  }

  post {
    success {
      echo "Despliegue completado correctamente."
      sh 'docker compose down'
    }
    failure {
      echo "Fallo en el despliegue. Revisa los logs."
    }
  }
}
