pipeline {
  agent any

  environment {
    CODECOV_TOKEN = credentials('CODECOV_TOKEN')
  }

  stages {

    stage('Checkout') {
      steps {
        echo "Clonando el repositorio..."
        checkout scm
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          set -e

          echo "Copiando proyecto a /tmp/petsalud..."
          rm -rf /tmp/petsalud
          mkdir -p /tmp/petsalud
          cp -r . /tmp/petsalud

          cd /tmp/petsalud

          echo "Construccion del proyecto..."
          docker compose down
          docker stop petsalud-frontend-1 && docker stop petsalud-backend-1 && docker stop petsalud-db-1
          docker rmi -f $(docker images -q)
          docker system prune -a -f
          docker compose build
          docker compose up db -d          
        '''
      }
    }

    stage('Start MySQL') {
      steps {
        sh '''
          echo "Levantando solo MySQL..."
          cd /tmp/petsalud
          echo "Esperando MySQL..."
          sleep 40
        '''
      }
    }

    stage('Run Tests in Backend Container') {
      steps {
        sh '''
          set -e
          cd /tmp/petsalud
          docker compose run --entrypoint "" backend bash -c "
            cd app &&
            pip install coverage pytest &&
            coverage run -m pytest tests &&
            coverage xml
          "
        '''
      }
    }

    stage('Copy Coverage Report to Host') {
      steps {
        sh '''
          set -e
          echo "Buscando contenedor donde se ejecutaron los tests..."

          CONTAINER_ID=$(docker ps -aq --filter "name=backend" --filter "status=exited" | head -n 1)

          echo "Contenedor encontrado: $CONTAINER_ID"

          docker cp $CONTAINER_ID:/app/app/coverage.xml coverage.xml
        '''
      }
    }

    stage('Upload to Codecov') {
      steps {
        sh '''
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          chmod +x codecov
          ./codecov -t ${CODECOV_TOKEN} -f coverage.xml
        '''
      }
    }

    stage('Desplegar proyecto completo') {
      steps {
        sh '''
          cd /tmp/petsalud
          docker compose up -d
          docker compose ps
        '''
      }
    }
  }

  post {
    success {
      echo "Despliegue completado correctamente."
    }
    failure {
      echo "Fallo en el despliegue. Revisa los logs."
    }
  }
}
